<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Konrad Kleine">
<title>Compiling a PGO optimized LLVM toolchain for Fedora</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #408080; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #7D9029 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #A0A000 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Compiling a PGO optimized LLVM toolchain for Fedora</h1>
<div class="details">
<span id="author" class="author">Konrad Kleine</span><br>
<span id="email" class="email"><a href="mailto:kkleine@redhat.com">kkleine@redhat.com</a></span><br>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph lead">
<p>In this experiment I try to show the steps I take to generate PGO profile data from compiling unmodified RPM packages and feeding those profiles into a PGO optimized rebuild of LLVM.</p>
</div>
<div class="paragraph">
<p>I create an instrumented LLVM toolchain in a Copr project called <code>llvm-pgo-instrumented</code>. In another Copr project called <code>profile-data-collection</code> I build a modified <code>redhat-rpm-config</code> package. Every package that gets built in that project will automatically produce a subpackage <code>&lt;PACKAGE&gt;-clang-profdata</code> with PGO profile data. I demonstrate this with a simple "Hello, World!" application that is called <code>myapp</code>. I then collect all those subpackages through <code>BuildRequires:</code> tags in another packaed called <code>llvm-pgo-profdata</code>. During the build of that package, all profiles are merged into an indexed profile data file. The final <code>llvm-pgo-profdata</code> RPM then installs the indexed profile data file into a location from which a PGO optimized build of LLVM can read it. This PGO optimized build of the LLVM toolchain is done in a third Copr project called <code>llvm-pgo-optimized</code>.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_non_goal">1. Non-goal</a></li>
<li><a href="#_resources">2. Resources</a></li>
<li><a href="#_understanding_what_pgo_can_do">3. Understanding what PGO can do</a></li>
<li><a href="#_step_0_build_a_pgo_instrumented_llvm">4. Step 0 - Build a PGO instrumented LLVM</a></li>
<li><a href="#_step_1_build_a_simple_hello_world_rpm">5. Step 1 - Build a simple "Hello, World!" RPM</a></li>
<li><a href="#_step_2_manually_add_profile_data_subpackage">6. Step 2 - Manually add profile data subpackage</a>
<ul class="sectlevel2">
<li><a href="#_subpackage_definition">6.1. Subpackage definition</a></li>
<li><a href="#_setting_the_llvm_profile_file">6.2. Setting the LLVM_PROFILE_FILE</a></li>
<li><a href="#_finding_and_merging_the_profiles">6.3. Finding and merging the profiles</a></li>
</ul>
</li>
<li><a href="#_step_3_generalize_manually_added_profile_data_subpackage">7. Step 3 - Generalize manually added profile data subpackage</a>
<ul class="sectlevel2">
<li><a href="#_genrealized_subpackage_definition">7.1. Genrealized subpackage definition</a></li>
<li><a href="#_generalized_llvm_profile_file">7.2. Generalized LLVM_PROFILE_FILE</a></li>
<li><a href="#_generalized_finding_and_merging_profiles">7.3. Generalized finding and merging profiles</a></li>
</ul>
</li>
<li><a href="#_step_4_automatically_add_profile_data_subpackage">8. Step 4 - Automatically add profile data subpackage</a>
<ul class="sectlevel2">
<li><a href="#_toggle">8.1. Toggle</a></li>
<li><a href="#_subpackage_template">8.2. Subpackage template</a></li>
<li><a href="#_setting_llvm_profile_file">8.3. Setting LLVM_PROFILE_FILE</a></li>
<li><a href="#_finding_and_merging_profiles">8.4. Finding and merging profiles</a></li>
<li><a href="#_building_patched_redhat_rpm_config_package">8.5. Building patched redhat-rpm-config package</a></li>
</ul>
</li>
<li><a href="#_step_5_build_unmodified_packages_on_copr">9. Step 5 - Build unmodified packages on Copr</a></li>
<li><a href="#_step_6_merge_raw_profiles">10. Step 6 - Merge Raw Profiles</a></li>
<li><a href="#_step_7_build_pgo_optimized_llvm">11. Step 7 - Build PGO optimized LLVM</a></li>
<li><a href="#_open_questions">12. Open questions:</a></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="process-overview.png?raw=true" alt="process overview">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_non_goal">1. Non-goal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is NOT a goal to get a perfectly tweaked PGO optimization build of LLVM. Instead we want to just show a way how to setup a pipeline in <a href="https://copr.fedorainfracloud.org/">Copr</a> for further tweaking and experimentation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">2. Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>For building LLVM with PGO: <a href="https://llvm.org/docs/HowToBuildWithPGO.html#building-clang-with-pgo" class="bare">https://llvm.org/docs/HowToBuildWithPGO.html#building-clang-with-pgo</a></p>
</li>
<li>
<p>PGO in general: <a href="https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization" class="bare">https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_understanding_what_pgo_can_do">3. Understanding what PGO can do</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>PGO (Profile-Guided Optimization) allows your compiler to better optimize code for how it actually runs. Users report that applying this to Clang and LLVM can decrease overall compile time by 20%.
(<a href="https://llvm.org/docs/HowToBuildWithPGO.html#introduction">Source</a>)</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Profile information enables better optimization. For example, knowing that a branch is taken very frequently helps the compiler make better decisions when ordering basic blocks. Knowing that a function <code>foo</code> is called more frequently than another function <code>bar</code> helps the inliner. Optimization levels <code>-O2</code> and above are recommended for use of profile guided optimization. [&#8230;&#8203;] [Be] careful to collect profiles by running your code with inputs that are representative of the typical behavior. Code that is not exercised in the profile will be optimized as if it is unimportant, and the compiler may make poor optimization choices for code that is disproportionately used while profiling.
(<a href="https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization">Source</a>)</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>For the <a href="https://getfedora.org/">Fedora Linux</a> distribution we build a ton of packages with LLVM. The aforementioned <strong>inputs</strong> are these packages themselves. The programs to optimize are those under the LLVM umbrella (e.g. <code>clang</code>).</p>
</div>
<div class="paragraph">
<p>The question is: How can we tap in the RPM build pipeline using <a href="https://copr.fedorainfracloud.org/">Copr</a> and build RPM packages without modifying their <code>*.spec</code> files manually?</p>
</div>
<div class="paragraph">
<p>I&#8217;ve created a 8 step experiment that shows how this can be achieved. For educational purposes I&#8217;ve written many of the steps using <code>Containerfile`s. This allows for a good level of isolation when you want to build the steps on your own. To run any of the steps on your own, you can run `make build-stepX</code> where $X \in \lbrace 0,1,2,&#8230;&#8203;,7 \rbrace$. But make sure you first read the description for each step below. Sometimes a step really only serves a documentation purpose.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>Containerfile`s run as `root</code> to allow packages to be installed and have a <code>tester</code> account for regular user interaction. Afterall the resulting images are not meant for anything but demonstration purposes and MUST NOT be used in production sites.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_0_build_a_pgo_instrumented_llvm">4. Step 0 - Build a PGO instrumented LLVM</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This step mainly exists for documentation purposes. If you <strong>do</strong> build this step on your own, make sure to walk through the files where there&#8217;s a reference to <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a> and change it to your project. I don&#8217;t see a need to consider this part of this excersise.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this step we&#8217;re going to create PGO instrumented LLVM packages and host them
for later consumption on a Copr project.</p>
</div>
<div class="paragraph">
<p>If you want to build this yourself, you need to have a valid Kerberos ticket. Try running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kinit &lt;FAS_USER&gt;@FEDORAPROJECT.ORG</pre>
</div>
</div>
<div class="paragraph">
<p>But rest assured, you don&#8217;t need to run this on your own. The <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a> project is ready for you to consume in the next steps.</p>
</div>
<div class="paragraph">
<p>In this step, we&#8217;re essentially following the <a href="https://llvm.org/docs/HowToBuildWithPGO.html#building-clang-with-pgo">official documentation</a> for how to build a PGO instumented clang.</p>
</div>
<div class="paragraph">
<p>The resulting <code>clang</code> will generate profile data upon execution and we&#8217;re trying to collect, bundle, and merge it for optimizing a rebuild of <code>clang</code> later.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_build_a_simple_hello_world_rpm">5. Step 1 - Build a simple "Hello, World!" RPM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this step we set the foundation for our experiment.</p>
</div>
<div class="paragraph">
<p>We have a simply "Hello, World!" application that we build and package as an RPM file.</p>
</div>
<div class="paragraph">
<p>The other steps build on this simple setup by first adding lines to the RPM spec file that we later want to generalize and finally auto-generate to come back to an unmodified spec file.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the <a href="step1/myapp/myapp.spec">specfile</a> first:</p>
</div>
<div class="paragraph">
<p><strong>step1/myapp/myapp.spec</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c"># See https://docs.fedoraproject.org/en-US/packaging-guidelines/#_compiler_macros</span>
%global toolchain clang

<span class="tok-gh">Name</span><span class="tok-p">:</span> myapp
<span class="tok-gh">Version</span><span class="tok-p">:</span> 1.0.0
<span class="tok-gh">Release</span><span class="tok-p">:</span> 1<span class="tok-nv">%{?dist}</span>
<span class="tok-gh">Summary</span><span class="tok-p">:</span> A simple <span class="tok-s2">&quot;Hello, World!&quot;</span> application.

<span class="tok-gh">License</span><span class="tok-p">:</span> Apache-2.0
<span class="tok-gh">URL</span><span class="tok-p">:</span> https://github.com/kwk/pgo-experiment
<span class="tok-gh">Source0</span><span class="tok-p">:</span> myapp-<span class="tok-kc">%{version}</span>.tar.bz2

<span class="tok-gh">BuildRequires</span><span class="tok-p">:</span>	clang
<span class="tok-gh">BuildRequires</span><span class="tok-p">:</span>	cmake
<span class="tok-gh">BuildRequires</span><span class="tok-p">:</span>	git

<span class="tok-nd">%description</span>
A simple &quot;Hello, World!&quot; application.

<span class="tok-nd">%prep</span>
%autosetup -S git

<span class="tok-nd">%build</span>
%cmake -DCMAKE_BUILD_TYPE=Release
%cmake_build

<span class="tok-nd">%install</span>
%cmake_install

<span class="tok-nd">%check</span>
test <span class="tok-s2">&quot;`</span><span class="tok-kc">%{buildroot}</span><span class="tok-s2">/</span><span class="tok-kp">%{_bindir}</span><span class="tok-s2">/myapp`&quot;</span> = <span class="tok-s2">&quot;Hello, World!&quot;</span>

<span class="tok-nd">%files</span>
%license LICENSE
<span class="tok-kp">%{_bindir}</span>/myapp

<span class="tok-nd">%changelog</span>
<span class="tok-gu">* Wed Mar 1 2023 Konrad Kleine &lt;kkleine@redhat.com&gt; - 1.0.0-1</span>
- Building step1
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the most simple specfile I could come up with for a "Hello, World!" application built with <code>clang</code>.</p>
</div>
<div class="paragraph">
<p>The <a href="step1/myapp/myapp.cpp">application code</a> itself is similarly short and throughout this experiment we never change it:</p>
</div>
<div class="paragraph">
<p><strong>step1/myapp/myapp.cpp</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;iostream&gt;</span><span class="tok-cp"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">argc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">argv</span><span class="tok-p">[])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">cout</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-w"> </span><span class="tok-s">&quot;Hello, World!&quot;</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-w"> </span><span class="tok-n">std</span><span class="tok-o">::</span><span class="tok-n">endl</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to build the RPM we use standard tools like <code>fedpkg</code> from a <a href="step1/myapp/Makefile"><code>step1/myapp/Makefile</code></a>:</p>
</div>
<div class="paragraph">
<p><strong>step1/myapp/Makefile</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="make"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c"># Prepare variables</span>
<span class="tok-nv">TMP</span> <span class="tok-o">=</span> <span class="tok-k">$(</span>CURDIR<span class="tok-k">)</span>/tmp
<span class="tok-nv">VERSION</span> <span class="tok-o">=</span> <span class="tok-k">$(</span>shell grep ^Version myapp.spec <span class="tok-p">|</span> sed <span class="tok-s1">&#39;s/.* //&#39;</span><span class="tok-k">)</span>
<span class="tok-nv">PACKAGE</span> <span class="tok-o">=</span> myapp-<span class="tok-k">$(</span>VERSION<span class="tok-k">)</span>
<span class="tok-nv">FILES</span> <span class="tok-o">=</span> LICENSE myapp.cpp <span class="tok-se">\</span>
		myapp.spec CMakeLists.txt

<span class="tok-nf">.PHONY</span><span class="tok-o">:</span> <span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-n">tarball</span><span class="tok-p">,</span> <span class="tok-n">rpm</span><span class="tok-p">,</span> <span class="tok-n">srpm</span><span class="tok-p">,</span> <span class="tok-n">clean</span>

<span class="tok-nf">source</span><span class="tok-o">:</span>
	mkdir -p <span class="tok-k">$(</span>TMP<span class="tok-k">)</span>/SOURCES
	mkdir -p <span class="tok-k">$(</span>TMP<span class="tok-k">)</span>/<span class="tok-k">$(</span>PACKAGE<span class="tok-k">)</span>
	cp -a <span class="tok-k">$(</span>FILES<span class="tok-k">)</span> <span class="tok-k">$(</span>TMP<span class="tok-k">)</span>/<span class="tok-k">$(</span>PACKAGE<span class="tok-k">)</span>
<span class="tok-nf">tarball</span><span class="tok-o">:</span> <span class="tok-n">source</span>
	<span class="tok-nb">cd</span> <span class="tok-k">$(</span>TMP<span class="tok-k">)</span> <span class="tok-o">&amp;&amp;</span> tar vcfj ../<span class="tok-k">$(</span>PACKAGE<span class="tok-k">)</span>.tar.bz2 <span class="tok-k">$(</span>PACKAGE<span class="tok-k">)</span>
<span class="tok-nf">rpm</span><span class="tok-o">:</span> <span class="tok-n">tarball</span>
	fedpkg --release f37 --name myapp <span class="tok-nb">local</span> -- --noclean
<span class="tok-nf">srpm</span><span class="tok-o">:</span> <span class="tok-n">tarball</span>
	fedpkg --release f37 --name myapp srpm
<span class="tok-nf">clean</span><span class="tok-o">:</span>
	rm -rf <span class="tok-k">$(</span>TMP<span class="tok-k">)</span> <span class="tok-k">$(</span>PACKAGE<span class="tok-k">)</span>*
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Within a <a href="step1/Containerfile"><code>Containerfile</code></a> we&#8217;re calling <code>make rpm</code> to build the <code>myapp-1.0.0-1.fc37.x86_64.rpm</code> RPM:</p>
</div>
<div class="paragraph">
<p><strong>step1/Containerfile</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">FROM</span> <span class="tok-s">fedora:37</span>
<span class="tok-k">LABEL</span> <span class="tok-nv">description</span><span class="tok-o">=</span><span class="tok-s2">&quot;A basic specfile-to-RPM process demo&quot;</span>

<span class="tok-c"># Install packages to build and package &quot;myapp&quot;</span>
<span class="tok-k">RUN</span> dnf install -y cmake fedora-packager git clang

<span class="tok-k">WORKDIR</span><span class="tok-s"> /root</span>
<span class="tok-k">RUN</span> useradd --create-home tester
<span class="tok-k">COPY</span> entrypoint.sh /root/entrypoint.sh
<span class="tok-k">COPY</span> ./myapp /home/tester/myapp
<span class="tok-k">RUN</span> chown -Rfv  tester:tester /home/tester/myapp

<span class="tok-k">USER</span><span class="tok-s"> root</span>
<span class="tok-k">ENTRYPOINT</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;/root/entrypoint.sh&quot;</span> <span class="tok-p">]</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the build is done, we stay in the container (see <code>bash</code> in the following shell script) and you have to manually exit it (e.g. using <code>&lt;ctrl&gt;+&lt;d&gt;</code>). We do this to allow you to look around in the build directories etc.</p>
</div>
<div class="paragraph">
<p><strong>step1/entrypoint.sh</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><pre><span></span><span class="tok-ch">#!/bin/bash</span>

<span class="tok-nb">set</span> -ex

<span class="tok-c1"># Build the app and always enter bash for further inspection</span>
<span class="tok-nb">cd</span> /home/tester/myapp
su -c <span class="tok-s2">&quot;make rpm&quot;</span> tester <span class="tok-o">||</span> <span class="tok-nb">true</span>

bash
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_manually_add_profile_data_subpackage">6. Step 2 - Manually add profile data subpackage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this step we manually add a <code>myapp-clang-pgo-profdata</code> subpackage which contains PGO profile data from LLVM. This data is generated by executing a PGO instrumented <code>clang</code> from the Copr repo <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a> which we&#8217;ve built in step 0.</p>
</div>
<div class="paragraph">
<p>The only changes from step1 to step2 are in the the <code>Containerfile</code> were we add the PGO instrumented LLVM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-k">RUN</span> dnf install -y <span class="tok-s1">&#39;dnf-command(copr)&#39;</span>
<span class="tok-k">RUN</span> dnf copr <span class="tok-nb">enable</span> -y kkleine/llvm-pgo-instrumented
<span class="tok-k">RUN</span> sudo dnf install -y <span class="tok-se">\</span>
    llvm <span class="tok-se">\</span>
    clang</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_subpackage_definition">6.1. Subpackage definition</h3>
<div class="paragraph">
<p>We add the subpackage manually in <a href="step2/myapp/myapp.spec">step2/myapp/myapp.spec</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><span></span><span class="tok-nd">%package</span> -n myapp-clang-pgo-profdata

<span class="tok-gh">Summary</span><span class="tok-p">:</span> Indexed PGO profile data from myapp package

<span class="tok-nd">%description</span> -n myapp-clang-pgo-profdata 
This package contains profiledata for clang that was generated while
compiling myapp. This can be used for doing Profile Guided Optimizations
(PGO) builds of clang.

<span class="tok-nd">%files</span> -n myapp-clang-pgo-profdata
/usr/lib64/clang-pgo-profdata/myapp/myapp.clang.profdata # <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Notice that the added <code>myapp-clang-pgo-profdata</code> subpackage requires this file <code>/usr/lib64/clang-pgo-profdata/myapp/myapp.clang.profdata</code>. It is a file that we have to create manually by invoking the PGO instrumented <code>clang</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_llvm_profile_file">6.2. Setting the LLVM_PROFILE_FILE</h3>
<div class="paragraph">
<p>By specifying <code>export LLVM_PROFILE_FILE="%t/myapp.clang.%m.profraw"</code> we instruct <code>clang</code> to create a raw profile file for each invocation under <code>TMPDIR</code> (see <code>%t</code> in <a href="https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program">the docs</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><span></span><span class="tok-c">#-----------------------------------------------------------------------</span>
<span class="tok-c"># We want the profile data to be written to specific files that will</span>
<span class="tok-c"># later land in the sub-package &quot;myapp-clang-raw-pgo-profdata&quot;. See</span>
<span class="tok-c"># https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program</span>
TMPDIR=<span class="tok-s2">&quot;</span><span class="tok-kp">%{_builddir}</span><span class="tok-s2">/raw-pgo-profdata&quot;</span>
export TMPDIR
mkdir -pv $TMPDIR
LLVM_PROFILE_FILE=<span class="tok-s2">&quot;%t/myapp.clang.%m.profraw&quot;</span>
export LLVM_PROFILE_FILE</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finding_and_merging_the_profiles">6.3. Finding and merging the profiles</h3>
<div class="paragraph">
<p>We then find all raw profiles and merge them into the final <code>myapp.clang.profdata</code> under the buildroot to be picked up by the <code>%files</code> section of the <code>myapp-clang-pgo-profdata</code> subpackage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><span></span>mkdir -pv <span class="tok-kc">%{buildroot}</span>/usr/lib64/clang-pgo-profdata/myapp
find <span class="tok-kp">%{_builddir}</span>/raw-pgo-profdata \
  -type f \
  -name <span class="tok-s2">&quot;myapp.clang.*.profraw&quot;</span> \
  &gt; <span class="tok-kp">%{_builddir}</span>/pgo-profiles

llvm-profdata merge \
  --debug-info-correlate \
  --enable-name-compression \
  -sparse $(cat <span class="tok-kp">%{_builddir}</span>/pgo-profiles) \
  -o <span class="tok-kc">%{buildroot}</span>/usr/lib64/clang-pgo-profdata/myapp/myapp.clang.profdata</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Why not store the raw profiles? In the first incarnation of this experiment I did store the raw profiles and I noticed that the final <code>myapp-clang-pgo-profdata</code> RPM was 128MB in size. When we first merge the profiles we get it down to ~900KB. I did a similar experiment for the <code>retsnoop</code> project and there the effect was also very big: ~1,4GB for raw profile data down to ~1,6MB for merged one.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can call <code>llvm-profdata merge</code> on already merged profiles!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, you may ask why we make the changes to the spec file at all when I promised that we get profile data from unmodified packages. The honest answer is that I didn&#8217;t know how to do it when I started out this experiment and I found the manual way much more easy to follow along compared to presenting the solution right away. This way we make transparent what needs to be generalized and automated.</p>
</div>
<div class="paragraph">
<p>In the next step we&#8217;re generalizing the manual addition of the subpackage before we remove it entirely from the spec file again.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3_generalize_manually_added_profile_data_subpackage">7. Step 3 - Generalize manually added profile data subpackage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this step we generalize the <code>myapp-clang-pgo-profdata</code> subpackage from step 2 to
<code>%{name}-%{toolchain}-clang-pgo-profdata</code>.</p>
</div>
<div class="paragraph">
<p>The only changes from step2 to step3 is in the <code>myapp/myapp.spec</code> file:</p>
</div>
<div class="sect2">
<h3 id="_genrealized_subpackage_definition">7.1. Genrealized subpackage definition</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><span></span><span class="tok-nd">%package</span> -n %{name}-%{toolchain}-raw-pgo-profdata

<span class="tok-gh">Summary</span><span class="tok-p">:</span> Indexed PGO profile data from <span class="tok-kc">%{name}</span> package

<span class="tok-nd">%description</span> -n %{name}-%{toolchain}-raw-pgo-profdata 
This package contains profiledata for %{toolchain} that was generated while
compiling %{name}. This can be used for doing Profile Guided Optimizations
(PGO) builds of %{toolchain}.

<span class="tok-nd">%files</span> -n %{name}-%{toolchain}-raw-pgo-profdata
<span class="tok-kp">%{_libdir}</span>/<span class="tok-kc">%{toolchain}</span>-pgo-profdata/<span class="tok-kc">%{name}</span>/<span class="tok-kc">%{name}</span>.<span class="tok-kc">%{toolchain}</span>.profdata</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generalized_llvm_profile_file">7.2. Generalized LLVM_PROFILE_FILE</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><span></span>TMPDIR=<span class="tok-s2">&quot;</span><span class="tok-kp">%{_builddir}</span><span class="tok-s2">/raw-pgo-profdata&quot;</span>
export TMPDIR
mkdir -pv $TMPDIR
LLVM_PROFILE_FILE=<span class="tok-s2">&quot;%t/</span><span class="tok-kc">%{name}</span><span class="tok-s2">.</span><span class="tok-kc">%{toolchain}</span><span class="tok-s2">.%m.profraw&quot;</span>
export LLVM_PROFILE_FILE</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generalized_finding_and_merging_profiles">7.3. Generalized finding and merging profiles</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><span></span>mkdir -pv <span class="tok-kc">%{buildroot}</span><span class="tok-kp">%{_libdir}</span>/<span class="tok-kc">%{toolchain}</span>-pgo-profdata/<span class="tok-kc">%{name}</span>
find <span class="tok-kp">%{_builddir}</span>/raw-pgo-profdata \
  -type f \
  -name <span class="tok-s2">&quot;</span><span class="tok-kc">%{name}</span><span class="tok-s2">.</span><span class="tok-kc">%{toolchain}</span><span class="tok-s2">.*.profraw&quot;</span> \
  &gt; <span class="tok-kp">%{_builddir}</span>/pgo-profiles

llvm-profdata merge \
  --debug-info-correlate \
  --enable-name-compression \
  -sparse $(cat <span class="tok-kp">%{_builddir}</span>/pgo-profiles) \
  -o <span class="tok-kc">%{buildroot}</span><span class="tok-kp">%{_libdir}</span>/<span class="tok-kc">%{toolchain}</span>-pgo-profdata/<span class="tok-kc">%{name}</span>/<span class="tok-kc">%{name}</span>.<span class="tok-kc">%{toolchain}</span>.profdata</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see that we&#8217;ve replaced all occurrences of <code>myapp</code> with the RPM specfile macro <code>%{name}</code> and the word <code>clang</code> with the <code>%{toolchain}</code> macro. That is essentially all we have to do now.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can specify <code>%global toolchain clang</code> to have your code compile with clang and use all the right and sane defaults for compiler flags for clang. See <a href="https://docs.fedoraproject.org/en-US/packaging-guidelines/#_compiler_macros" class="bare">https://docs.fedoraproject.org/en-US/packaging-guidelines/#_compiler_macros</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_4_automatically_add_profile_data_subpackage">8. Step 4 - Automatically add profile data subpackage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this step we use the <code>myapp</code> directory from <code>step1</code> that doesn&#8217;t contain any information about the subpackage at all. And yet we&#8217;re still gonna get our subpackage with profile data. We do this by patching, compiling and installing another package that is always present on Fedora: <code>redhat-rpm-config</code>. This package is the home of many useful build-flags and macros but it also allows us to tap into the build process by.</p>
</div>
<div class="sect2">
<h3 id="_toggle">8.1. Toggle</h3>
<div class="paragraph">
<p>To toggle the profile generation on an off we have defined the <code>%_toolchain_profile_subpackages</code>. It is on by default and to disable the generation of profile subpackages you need to specify <code>%global _toolchain_profile_subpackages %{nil}</code> this in your specfile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><pre><span></span>%_toolchain_profile_subpackages 1
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Currently there&#8217;s no sanity checking of whether or not a package can even produce PGO profiles. If there&#8217;s no compiler or the compiler is not clang, my patch doesn&#8217;t work. But right now we don&#8217;t care so much about this and consider it an optimization for later. I just wanted to let you know.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_subpackage_template">8.2. Subpackage template</h3>
<div class="paragraph">
<p>The subpackage can be generalized with the following template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c"># Generate profiledata packages for the compiler</span>
%_toolchain_profile_subpackage_template \
<span class="tok-nd">%package</span> -n %{name}-%{toolchain}-pgo-profdata \
<span class="tok-gh">Summary</span><span class="tok-p">:</span> Indexed PGO profile data from <span class="tok-kc">%{name}</span> package \
<span class="tok-nd">%description</span> -n %{name}-%{toolchain}-pgo-profdata \
This package contains profiledata for %{toolchain} that was generated while \
compiling %{name}. This can be used for doing Profile Guided Optimizations \
(PGO) builds of %{toolchain} \
<span class="tok-nd">%files</span> -n %{name}-%{toolchain}-pgo-profdata \
<span class="tok-kp">%{_libdir}</span>/<span class="tok-kc">%{toolchain}</span>-pgo-profdata/<span class="tok-kc">%{name}</span>/<span class="tok-kc">%{name}</span>.<span class="tok-kc">%{toolchain}</span>.profdata \
<span class="tok-kc">%{nil}</span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_llvm_profile_file">8.3. Setting LLVM_PROFILE_FILE</h3>
<div class="paragraph">
<p>We export the <code>LLVM_PROFILE_FILE</code> environment variable at the right place.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><pre><span></span>%set_build_flags \
  CFLAGS=<span class="tok-s2">&quot;${CFLAGS:-</span><span class="tok-kc">%{build_cflags}</span><span class="tok-s2">}&quot;</span> ; export CFLAGS ; \
  CXXFLAGS=<span class="tok-s2">&quot;${CXXFLAGS:-</span><span class="tok-kc">%{build_cxxflags}</span><span class="tok-s2">}&quot;</span> ; export CXXFLAGS ; \
  FFLAGS=<span class="tok-s2">&quot;${FFLAGS:-</span><span class="tok-kc">%{build_fflags}</span><span class="tok-s2">}&quot;</span> ; export FFLAGS ; \
  FCFLAGS=<span class="tok-s2">&quot;${FCFLAGS:-</span><span class="tok-kc">%{build_fflags}</span><span class="tok-s2">}&quot;</span> ; export FCFLAGS ; \
  LDFLAGS=<span class="tok-s2">&quot;${LDFLAGS:-</span><span class="tok-kc">%{build_ldflags}</span><span class="tok-s2">}&quot;</span> ; export LDFLAGS ; \
  LT_SYS_LIBRARY_PATH=<span class="tok-s2">&quot;${LT_SYS_LIBRARY_PATH:-</span><span class="tok-kp">%_libdir</span><span class="tok-s2">:}&quot;</span> ; export LT_SYS_LIBRARY_PATH ; \
  CC=<span class="tok-s2">&quot;${CC:-</span><span class="tok-nf">%{__cc}</span><span class="tok-s2">}&quot;</span> ; export CC ; \
  CXX=<span class="tok-s2">&quot;${CXX:-</span><span class="tok-nf">%{__cxx}</span><span class="tok-s2">}&quot;</span> ; export CXX ; \
  [ <span class="tok-s2">&quot;%_toolchain_profile_subpackages&quot;</span> = 1 ] &amp;&amp; TMPDIR=<span class="tok-s2">&quot;</span><span class="tok-kp">%{_builddir}</span><span class="tok-s2">/raw-pgo-profdata&quot;</span> &amp;&amp; export TMPDIR &amp;&amp; mkdir -pv $TMPDIR &amp;&amp; \
  LLVM_PROFILE_FILE=<span class="tok-s2">&quot;%t/</span><span class="tok-kc">%{name}</span><span class="tok-s2">.</span><span class="tok-kc">%{toolchain}</span><span class="tok-s2">.%m.profraw&quot;</span> &amp;&amp; export LLVM_PROFILE_FILE ;
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finding_and_merging_profiles">8.4. Finding and merging profiles</h3>
<div class="paragraph">
<p>We tap in the post-<code>%install</code> step to find and merge the profiles into the buildroot location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="spec"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nf">%__copy_profraw</span> %[ 0%{_toolchain_profile_subpackages} &gt; 0 ? <span class="tok-s2">&quot;mkdir -pv </span><span class="tok-kc">%{buildroot}</span><span class="tok-kp">%{_libdir}</span><span class="tok-s2">/</span><span class="tok-kc">%{toolchain}</span><span class="tok-s2">-pgo-profdata/</span><span class="tok-kc">%{name}</span><span class="tok-s2"> &amp;&amp; find </span><span class="tok-kp">%{_builddir}</span><span class="tok-s2">/raw-pgo-profdata -type f -name &#39;</span><span class="tok-kc">%{name}</span><span class="tok-s2">.</span><span class="tok-kc">%{toolchain}</span><span class="tok-s2">.*.profraw&#39; &gt; </span><span class="tok-kp">%{_builddir}</span><span class="tok-s2">/pgo-profiles &amp;&amp; llvm-profdata merge --debug-info-correlate --enable-name-compression -sparse $(cat </span><span class="tok-kp">%{_builddir}</span><span class="tok-s2">/pgo-profiles) -o </span><span class="tok-kc">%{buildroot}</span><span class="tok-kp">%{_libdir}</span><span class="tok-s2">/</span><span class="tok-kc">%{toolchain}</span><span class="tok-s2">-pgo-profdata/</span><span class="tok-kc">%{name}</span><span class="tok-s2">/</span><span class="tok-kc">%{name}</span><span class="tok-s2">.</span><span class="tok-kc">%{toolchain}</span><span class="tok-s2">.profdata&quot;</span> : <span class="tok-s2">&quot;</span><span class="tok-kc">%{nil}</span><span class="tok-s2">&quot;</span> ]

<span class="tok-nf">%__os_install_post</span>    \
    <span class="tok-nv">%{?__brp_ldconfig}</span> \
    <span class="tok-nv">%{?__brp_compress}</span> \
    %{!?__debug_package:\
    <span class="tok-nv">%{?__brp_strip}</span> \
    <span class="tok-nv">%{?__brp_strip_comment_note}</span> \
    } \
    <span class="tok-nv">%{?__brp_strip_lto}</span> \
    <span class="tok-nv">%{?__brp_strip_static_archive}</span> \
    <span class="tok-nv">%{?__brp_check_rpaths}</span> \
    <span class="tok-nv">%{?__brp_mangle_shebangs}</span> \
    <span class="tok-nv">%{?__brp_remove_la_files}</span> \
    <span class="tok-nf">%{__os_install_post_python}</span> \
    %{?_toolchain_profile_subpackages:<span class="tok-nv">%{?__copy_profraw}</span>} \
<span class="tok-kc">%{nil}</span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_patched_redhat_rpm_config_package">8.5. Building patched redhat-rpm-config package</h3>
<div class="paragraph">
<p>In order to build the <code>redhat-rpm-config</code> we build the package using <code>fedpkg local</code>. Then we can simply imstall the resulting RPM using <code>dnf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c1"># Build and install our customized redhat-rpm-config</span>
<span class="tok-nb">cd</span> /root/redhat-rpm-config
fedpkg --release f37 <span class="tok-nb">local</span>
sudo dnf install -y --disablerepo<span class="tok-o">=</span>* noarch/redhat-rpm-config-230-1.fc37.noarch.rpm
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>NOTICE: There&#8217;s no <code>step4/myapp</code> directory. This is because we copy it from step1 in the top-level <a href="Makefile"><code>Makefile</code></a>. This is supposed to emphasize the point that we don&#8217;t modify the spec file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="make"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nf">build-step4</span><span class="tok-o">:</span>
	rm -rf step4/myapp
	cp -rf step1/myapp step4/myapp
	podman build -t pgo-experiment-step4 ./step4
	-podman rm -f pgo-experiment-step4
	podman run -it --name pgo-experiment-step4 pgo-experiment-step4
	podman cp pgo-experiment-step4:/home/tester/myapp/x86_64/myapp-clang-profdata-1.0.0-1.fc37.x86_64.rpm step4/myapp-clang-profdata-1.0.0-1.fc37.x86_64.rpm
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_5_build_unmodified_packages_on_copr">9. Step 5 - Build unmodified packages on Copr</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You don&#8217;t need to run this step manually. It has already been run and the results are in the Copr project
<a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/profile-data-collection</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Up until this point all of our experiments look promising but how can we use Copr to build packages and produce <code>&lt;PACKAGE&gt;-clang-profdata</code> packages automatically for us?</p>
</div>
<div class="paragraph">
<p>Copr will become the storage for our profile data subpackages with all the rest of the regular packages.</p>
</div>
<div class="paragraph">
<p>After running this step using <code>make build-step5</code>, we&#8217;re gonna have a project called: <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/profile-data-collection</a>.</p>
</div>
<div class="paragraph">
<p>In that project, there will be the patched <code>redhat-rpm-config</code> package and the
<code>myapp</code> package with the additional subpackage inside:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="profile-data-collection.png?raw=true" alt="profile data collection">
</div>
</div>
<div class="paragraph">
<p>In order for the Copr project to use our PGO instrumented LLVM we&#8217;ve made the repo available in the <a href="step5/Makefile"><code>step5/Makefile</code></a> using the <code>--repo</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="Makefile"><span></span>copr create --chroot fedora-37-x86_64 --unlisted-on-hp on --repo copr://$(fas_user)/llvm-pgo-instrumented $(copr_project)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any package that will be built after <code>redhat-rpm-config</code> in the {https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/[kkleine/profile-data-collection] Copr project will automatically have a <code>&lt;package&gt;-clang-profdata</code> subpackage that we can download in a later step to merge and feed it in the final, optimized build of LLVM.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_6_merge_raw_profiles">10. Step 6 - Merge Raw Profiles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to optimize LLVM with the raw profile data that we&#8217;ve collected before we need to make it available to the Copr build of LLVM and we need to <a href="https://llvm.org/docs/CommandGuide/llvm-profdata.html#profdata-merge">merge</a> it using <code>llvm-profdata merge</code>.</p>
</div>
<div class="paragraph">
<p>Merging takes "[&#8230;&#8203;] takes several profile data files generated by PGO instrumentation and merges them together into a single indexed profile data file."</p>
</div>
<div class="paragraph">
<p>The <code>&lt;PACKAGE&gt;-clang-profdata</code> packages that we&#8217;ve build so far should be installable standalone when we build a PGO optimized version of LLVM. In other words, when we add a <code>BuildRequires: myapp-clang-pgo-profdata</code> to the spec file of LLVM, we should be able to consume the raw profile data for merging. The problem is that in Fedora as well as RHEL and CentOS Stream we use a mode call "standalone-build". That means, we&#8217;re building each sub-project of LLVM (e.g. <code>clang</code>, <code>llvm</code>, <code>lld</code>) with its own specfile. To avoid merging the raw profile data into an indexed profile data file more than once we&#8217;re offloading the merge process into its own RPM. We call it <code>llvm-pgo-profdata</code>.</p>
</div>
<div class="paragraph">
<p>The <a href="step6/llvm-pgo-profdata/llvm-pgo-profdata.spec"><code>step6/llvm-pgo-profdata/llvm-pgo-profdata.spec</code></a> contains this line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rpm"><span></span>%global _toolchain_profile_subpackages %{nil}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This effectively disables the generation of raw profile data when we build <code>llvm-pgo-profdata</code> in the {https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/[kkleine/profile-data-collection] Copr project. Remember, there we have the modified <code>redhat-rpm-config</code> package that would immediately kick in an try to do it&#8217;s job. But for the <code>llvm-pgo-profdata</code> package we don&#8217;t want that.</p>
</div>
<div class="paragraph">
<p>Essentially all the <code>llvm-pgo-profdata</code> do is to merge all <code>&lt;PACKAGE&gt;-clang-profdata</code> files it can under <code>/usr/lib/profraw/</code> and store the result in <code>/usr/lib/profdata/llvm-merged.profdata</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_7_build_pgo_optimized_llvm">11. Step 7 - Build PGO optimized LLVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This step is similar to step 0 in which we&#8217;ve build the PGO instrumented LLVM. Here we&#8217;re adding a buil requirement for <code>llvm-pgo-profdata</code> and use the <code>/usr/lib/profdata/llvm-merged.profdata</code> file as input for the optimization of the <code>llvm</code>, <code>clang</code> and <code>lld</code> packages.</p>
</div>
<div class="paragraph">
<p>The resulting PGO optimized packages will be available on <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-optimized</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_open_questions">12. Open questions:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>What happens to packages that don&#8217;t use <code>%global toolchain clang</code>? - Not important right now</p>
</li>
<li>
<p>Outlook: Move redhat-rpm-config stuff into clang-instrument-macros or alike.</p>
</li>
<li>
<p>Performance benefits: any profile is good?</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-03-21 15:02:01 +0100
</div>
</div>
</body>
</html>