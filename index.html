<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Konrad Kleine">
<title>A PGO optimized LLVM toolchain for Fedora</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>A PGO optimized LLVM toolchain for Fedora</h1>
<div class="details">
<span id="author" class="author">Konrad Kleine</span><br>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<!-- toc disabled -->
<div class="paragraph lead">
<p>In this experiment we generate PGO profile data from compiling unmodified RPM packages and feed those profiles into a PGO optimized rebuild of LLVM.</p>
</div>
<div class="paragraph">
<p>We create an instrumented LLVM toolchain in a Copr project called <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a>. In another Copr project called <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/profile-data-collection</a> we build a modified <code>redhat-rpm-config</code> package. Every package that gets built in that project will automatically produce a subpackage <code>&lt;PACKAGE&gt;-clang-profdata</code> with PGO profile data. We demonstrate this with a simple "Hello, World!" application that is called <code>myapp</code>. We then collect all those subpackages through <code>BuildRequires:</code> tags in another package called <code>llvm-pgo-profdata</code>. During the build of that package, all profiles are merged into an indexed profile data file. The final <code>llvm-pgo-profdata</code> RPM then installs the indexed profile data file into a location from which a PGO optimized build of LLVM can read it. This PGO optimized build of the LLVM toolchain is done in a third Copr project called <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-optimized</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="process-overview.png" alt="process overview">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_non_goal"><a class="anchor" href="#_non_goal"></a><a class="link" href="#_non_goal">1. Non-goal</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is not a goal to get a perfectly tweaked PGO optimization build of LLVM. Instead we want to explor a way how to setup a pipeline in <a href="https://copr.fedorainfracloud.org/">Copr</a> for further tweaking and experimentation.</p>
</div>
<div class="paragraph">
<p>The only operating system that we build for in this experiment is Fedora 37 on x86_64.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_understand_what_pgo_can_do"><a class="anchor" href="#_understand_what_pgo_can_do"></a><a class="link" href="#_understand_what_pgo_can_do">2. Understand what PGO can do</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>PGO (Profile-Guided Optimization) allows your compiler to better optimize code for how it actually runs. Users report that applying this to Clang and LLVM can decrease overall compile time by 20%.
(<a href="https://llvm.org/docs/HowToBuildWithPGO.html#introduction">Source</a>)</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Profile information enables better optimization. For example, knowing that a branch is taken very frequently helps the compiler make better decisions when ordering basic blocks. Knowing that a function <code>foo</code> is called more frequently than another function <code>bar</code> helps the inliner. Optimization levels <code>-O2</code> and above are recommended for use of profile guided optimization. [&#8230;&#8203;] [Be] careful to collect profiles by running your code with inputs that are representative of the typical behavior. Code that is not exercised in the profile will be optimized as if it is unimportant, and the compiler may make poor optimization choices for code that is disproportionately used while profiling.
(<a href="https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization">Source</a>)</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>For the <a href="https://getfedora.org/">Fedora Linux</a> distribution we build a ton of packages with LLVM. The aforementioned <strong>inputs</strong> are these packages themselves. The programs to optimize are those under the LLVM umbrella (e.g. <code>clang</code>).</p>
</div>
<div class="paragraph">
<p>The question is: How can we tap in the RPM build pipeline using <a href="https://copr.fedorainfracloud.org/">Copr</a> and build RPM packages without modifying their <code>*.spec</code> files manually?</p>
</div>
<div class="paragraph">
<p>I&#8217;ve created a 8 step experiment that shows how this can be achieved. For educational purposes I&#8217;ve written many of the steps using <code>Containerfile</code> s. This allows for a good level of isolation when you want to build the steps on your own. To run any of the steps on your own, you can run <code>make build-stepX</code> where \$X \in {0,1,2,...,7}\$. But make sure you first read the description for each step below. Sometimes a step really only serves a documentation purpose.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>Containerfile</code> s run as <code>root</code> to allow packages to be installed and have a <code>tester</code> account for regular user interaction. Afterall the resulting images are not meant for anything but demonstration purposes and MUST NOT be used in production sites.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_how_to_follow_along"><a class="anchor" href="#_how_to_follow_along"></a><a class="link" href="#_how_to_follow_along">2.1. How to follow along?</a></h3>
<div class="paragraph">
<p>I&#8217;ve been writing and testing everything on a <a href="https://getfedora.org/">Fedora Linux</a> 37 laptop with <code>make</code>, <code>git</code>, <code>fedpkg</code>, and <code>podman</code> installed.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a good starting point for preparing your system if you want to follow along. Don&#8217;t worry we don&#8217;t install any custom RPM on your system. Everything is build either in a podman container or on <a href="https://copr.fedorainfracloud.org/">Copr</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ sudo dnf install -y git make fedpkg podman fedora-packager krb5-workstation asciidoctor pandoc # <b class="conum">(1)</b>
$ gem install pygments.rb asciimath <b class="conum">(2)</b>
$ git clone --recurse-submodules https://github.com/kwk/pgo-experiment.git # <b class="conum">(3)</b>
$ cd pgo-experiment # <b class="conum">(4)</b>
$ kinit &lt;FAS_USER&gt;@FEDORAPROJECT.ORG # <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Install packages that you need in order to build the <a href="#steps">Steps</a>. Maybe this list is not capturing everything you need but at least most of it. <code>asciidoctor</code> is optional for building this documentation using <code>make docs</code>.</p>
</li>
<li>
<p>OPTIONAL: Installing these ruby gems is only for building these docs using <code>make docs</code>.</p>
</li>
<li>
<p>Clone the project including submodules.</p>
</li>
<li>
<p>Navigate to the project&#8217;s root directory.</p>
</li>
<li>
<p>OPTIONAL: If you want to build the steps that involve the <code>copr</code> CLI, you need to have a valid Kerberos ticket. Replace <code>&lt;FAS_USER&gt;</code> with the your own Fedora FAS user name.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="steps"><a class="anchor" href="#steps"></a><a class="link" href="#steps">3. Steps</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="step0"><a class="anchor" href="#step0"></a><a class="link" href="#step0">3.1. Step 0 - Build a PGO instrumented LLVM</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This step mainly exists for documentation purposes. If you <strong>do</strong> build this step on your own, make sure to walk through the files where there&#8217;s a reference to <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a> and change it to your project. I don&#8217;t see a need to consider this part of this excersise. All we have to do is really pass along a few CMake flags when building the LLVM RPM packages: <code>llvm</code>, <code>clang</code>, and <code>lld</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this step, we&#8217;re essentially following the <a href="https://llvm.org/docs/HowToBuildWithPGO.html#building-clang-with-pgo">official documentation</a> for how to build a PGO instumented clang. In this step we&#8217;re going to create PGO instrumented LLVM packages and host them for later consumption on a Copr project. The resulting <code>clang</code> will generate profile data upon execution and we&#8217;re trying to collect, bundle, and merge it for optimizing a rebuild of the LLVM toolchain later (<a href="#step7">Step 7 - Build PGO optimized LLVM</a>). But rest assured, you don&#8217;t need to run this on your own. The <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a> project is ready for you to consume in the next steps. So you&#8217;re free to continue with <a href="#step1">Step 1 - Build "Hello, World!" RPM</a>.</p>
</div>
<div class="sect3">
<h4 id="_spec_file_modifications"><a class="anchor" href="#_spec_file_modifications"></a><a class="link" href="#_spec_file_modifications">3.1.1. Spec file modifications</a></h4>
<div class="paragraph">
<p>I&#8217;ve set up <code>pgo-experiment</code> branches in each of the following package repositories on the Fedora Source:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://src.fedoraproject.org/fork/kkleine/rpms/llvm/tree/pgo-experiment" class="bare">https://src.fedoraproject.org/fork/kkleine/rpms/llvm/tree/pgo-experiment</a></p>
</li>
<li>
<p><a href="https://src.fedoraproject.org/fork/kkleine/rpms/clang/tree/pgo-experiment" class="bare">https://src.fedoraproject.org/fork/kkleine/rpms/clang/tree/pgo-experiment</a></p>
</li>
<li>
<p><a href="https://src.fedoraproject.org/fork/kkleine/rpms/lld/tree/pgo-experiment" class="bare">https://src.fedoraproject.org/fork/kkleine/rpms/lld/tree/pgo-experiment</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In all of these repositries I&#8217;ve essentially done the same changes. At first I&#8217;ve added a <a href="https://rpm-software-management.github.io/rpm/manual/conditionalbuilds.html">build-conditional</a> that is off by default:</p>
</div>
<div class="listingblock">
<div class="title">step0/llvm/llvm.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%bcond_with pgo_instrumented_build
%bcond_with pgo_optimized_build</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, one is for building an instrumented package and one is for building an optimized package. In <a href="#step7">Step 7 - Build PGO optimized LLVM</a> we&#8217;re using the <code>pgo_optimized_build</code> but here we&#8217;re only turning on <code>pgo_instrumented_build</code> in our <code>Makefile</code>:</p>
</div>
<div class="listingblock">
<div class="title">step0/Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-make" data-lang="make">.PHONY: create-copr-project
create-copr-project:
	-copr create --chroot fedora-37-x86_64 --unlisted-on-hp on $(copr_project)
	-copr modify --chroot fedora-37-x86_64 --unlisted-on-hp on $(copr_project)
	copr edit-chroot --rpmbuild-with pgo_instrumented_build  $(fas_user)/$(copr_project)/fedora-37-x86_64 # <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here we modify a particular <code>fedora-37-x86_64</code> chroot of the <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a> project to use <code>--with pgo_instrumented_build</code> when invoking <code>mock</code> to build our packages.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Another change I had to make was adding a build dependency on <code>compiler-rt</code>:</p>
</div>
<div class="listingblock">
<div class="title">step0/llvm/llvm.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%if %{with pgo_instrumented_build}
BuildRequires: compiler-rt
%endif</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When building the monorepo all at once you probably don&#8217;t notice this dependency right away.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then we&#8217;re modifying the the CMake arguments according to the <a href="https://llvm.org/docs/HowToBuildWithPGO.html#building-clang-with-pgo">official documentation</a>.</p>
</div>
<div class="listingblock">
<div class="title">step0/llvm/llvm.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%if %{with pgo_instrumented_build}
	-DLLVM_BUILD_INSTRUMENTED=IR \
	-DLLVM_BUILD_RUNTIME=No \
	-DLLVM_VP_COUNTERS_PER_SITE=8 \
%endif</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>There were a couple of errors that I ran into. One basically said:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><code>Error: LLVM Profile Warning: Unable to track new values: Running out of static counters. Consider using option -mllvm -vp-counters-per-site=&lt;n&gt; to allocate more value profile counters at compile time.</code></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>As a solution I&#8217;ve added the <code>--vp-counters-per-site</code> option but this resulted in a follow-up error:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><code>Error: clang (LLVM option parsing): for the --vp-counters-per-site option: may only occur zero or one times!</code></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The solution was to modify <code>vp-counters-per-site</code> option through <code>LLVM_VP_COUNTERS_PER_SITE</code> instead of adding it, hence the <code>-DLLVM_VP_COUNTERS_PER_SITE=8</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To build this step, run <code>make build-step0</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step1"><a class="anchor" href="#step1"></a><a class="link" href="#step1">3.2. Step 1 - Build "Hello, World!" RPM</a></h3>
<div class="paragraph">
<p>In this step we set the foundation for our experiment.</p>
</div>
<div class="paragraph">
<p>We have a simple "Hello, World!" application that we build and package as an RPM file.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
This step does NOT depend on <a href="#step0">Step 0 - Build a PGO instrumented LLVM</a>. So you should be good to just run <code>make build-step1</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other steps build on this simple setup by first adding lines to the RPM spec file that we later want to generalize and finally auto-generate to come back to an unmodified spec file.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the <a href="step1/myapp/myapp.spec">specfile</a> first:</p>
</div>
<div class="listingblock">
<div class="title">step1/myapp/myapp.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec"># See https://docs.fedoraproject.org/en-US/packaging-guidelines/#_compiler_macros
%global toolchain clang

Name: myapp
Version: 1.0.0
Release: 1%{?dist}
Summary: A simple "Hello, World!" application.

License: Apache-2.0
URL: https://github.com/kwk/pgo-experiment
Source0: myapp-%{version}.tar.bz2

BuildRequires:	clang
BuildRequires:	cmake
BuildRequires:	git

%description
A simple "Hello, World!" application.

%prep
%autosetup -S git

%build
%cmake -DCMAKE_BUILD_TYPE=Release
%cmake_build

%install
%cmake_install

%check
test "`%{buildroot}/%{_bindir}/myapp`" = "Hello, World!"

%files
%license LICENSE
%{_bindir}/myapp

%changelog
* Wed Mar 1 2023 Konrad Kleine &lt;kkleine@redhat.com&gt; - 1.0.0-1
- Building step1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the most simple specfile I could come up with for a "Hello, World!" application built with <code>clang</code>.</p>
</div>
<div class="paragraph">
<p>The <a href="step1/myapp/myapp.cpp">application code</a> itself is similarly short and throughout this experiment we never change it:</p>
</div>
<div class="listingblock">
<div class="title">step1/myapp/myapp.cpp</div>
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;iostream&gt;

int main(int argc, char *argv[]) {
    std::cout &lt;&lt; "Hello, World!" &lt;&lt; std::endl;
    return 0;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to build the RPM we use standard tools like <code>fedpkg</code> from a <a href="step1/myapp/Makefile"><code>step1/myapp/Makefile</code></a>:</p>
</div>
<div class="listingblock">
<div class="title">step1/myapp/Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-make" data-lang="make"># Prepare variables
TMP = $(CURDIR)/tmp
VERSION = $(shell grep ^Version myapp.spec | sed 's/.* //')
PACKAGE = myapp-$(VERSION)
FILES = LICENSE myapp.cpp \
		myapp.spec CMakeLists.txt

.PHONY: source, tarball, rpm, srpm, clean

source:
	mkdir -p $(TMP)/SOURCES
	mkdir -p $(TMP)/$(PACKAGE)
	cp -a $(FILES) $(TMP)/$(PACKAGE)
tarball: source
	cd $(TMP) &amp;&amp; tar vcfj ../$(PACKAGE).tar.bz2 $(PACKAGE)
rpm: tarball
	fedpkg --release f37 --name myapp local -- --noclean
srpm: tarball
	fedpkg --release f37 --name myapp srpm
clean:
	rm -rf $(TMP) $(PACKAGE)*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within a <a href="step1/Containerfile"><code>Containerfile</code></a> we&#8217;re calling <code>make rpm</code> to build the <code>myapp-1.0.0-1.fc37.x86_64.rpm</code> RPM:</p>
</div>
<div class="listingblock">
<div class="title">step1/Containerfile</div>
<div class="content">
<pre class="highlight"><code class="language-dockerfile" data-lang="dockerfile">FROM fedora:37
LABEL description="A basic specfile-to-RPM process demo"

# Install packages to build and package "myapp"
RUN dnf install -y cmake fedora-packager git clang

WORKDIR /root
RUN useradd --create-home tester
COPY entrypoint.sh /root/entrypoint.sh
COPY ./myapp /home/tester/myapp
RUN chown -Rfv  tester:tester /home/tester/myapp

USER root
ENTRYPOINT [ "/root/entrypoint.sh" ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the build is done, we stay in the container (see <code>bash</code> in the following shell script) and you have to manually exit it (e.g. using <code>&lt;ctrl&gt;+&lt;d&gt;</code>). We do this to allow you to look around in the build directories etc.</p>
</div>
<div class="listingblock">
<div class="title">step1/entrypoint.sh</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">#!/bin/bash

set -ex

# Build the app and always enter bash for further inspection
cd /home/tester/myapp
su -c "make rpm" tester || true

bash</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step2"><a class="anchor" href="#step2"></a><a class="link" href="#step2">3.3. Step 2 - Manually add subpackage</a></h3>
<div class="paragraph">
<p>In this step we manually add a <code>myapp-clang-pgo-profdata</code> subpackage which contains PGO profile data from LLVM. This data is generated by executing a PGO instrumented <code>clang</code> from the Copr repo <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-instrumented</a> which we&#8217;ve built in step 0.</p>
</div>
<div class="paragraph">
<p>The only changes from step1 to step2 are in the the <code>Containerfile</code> were we add the PGO instrumented LLVM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dockerfile" data-lang="dockerfile">RUN dnf install -y 'dnf-command(copr)'
RUN dnf copr enable -y kkleine/llvm-pgo-instrumented
RUN sudo dnf install -y \
    llvm \
    clang</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_subpackage_definition"><a class="anchor" href="#_subpackage_definition"></a><a class="link" href="#_subpackage_definition">3.3.1. Subpackage definition</a></h4>
<div class="paragraph">
<p>We add the subpackage manually in <a href="step2/myapp/myapp.spec">step2/myapp/myapp.spec</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%package -n myapp-clang-pgo-profdata

Summary: Indexed PGO profile data from myapp package

%description -n myapp-clang-pgo-profdata 
This package contains profiledata for clang that was generated while
compiling myapp. This can be used for doing Profile Guided Optimizations
(PGO) builds of clang.

%files -n myapp-clang-pgo-profdata
/usr/lib64/clang-pgo-profdata/myapp/myapp.clang.profdata</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the added <code>myapp-clang-pgo-profdata</code> subpackage requires this file <code>/usr/lib64/clang-pgo-profdata/myapp/myapp.clang.profdata</code>. It is a file that we have to create manually by invoking the PGO instrumented <code>clang</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_set_llvm_profile_file"><a class="anchor" href="#_set_llvm_profile_file"></a><a class="link" href="#_set_llvm_profile_file">3.3.2. Set LLVM_PROFILE_FILE</a></h4>
<div class="paragraph">
<p>By specifying <code>export LLVM_PROFILE_FILE="%t/myapp.clang.%m.profraw"</code> we instruct <code>clang</code> to create a raw profile file for each invocation under <code>TMPDIR</code> (see <code>%t</code> in <a href="https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program">the docs</a>).</p>
</div>
<div class="listingblock">
<div class="title">step2/myapp/myapp.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">#-----------------------------------------------------------------------
# We want the profile data to be written to specific files that will
# later land in the sub-package "myapp-clang-raw-pgo-profdata". See
# https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program
TMPDIR="%{_builddir}/raw-pgo-profdata"
export TMPDIR
mkdir -pv $TMPDIR
LLVM_PROFILE_FILE="%t/myapp.clang.%m.%p.profraw"
export LLVM_PROFILE_FILE</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_find_and_merge_the_profiles"><a class="anchor" href="#_find_and_merge_the_profiles"></a><a class="link" href="#_find_and_merge_the_profiles">3.3.3. Find and merge the profiles</a></h4>
<div class="paragraph">
<p>We then find all raw profiles and merge them into the final <code>myapp.clang.profdata</code> under the buildroot to be picked up by the <code>%files</code> section of the <code>myapp-clang-pgo-profdata</code> subpackage:</p>
</div>
<div class="listingblock">
<div class="title">step2/myapp/myapp.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">mkdir -pv %{buildroot}/usr/lib64/clang-pgo-profdata/myapp
find %{_builddir}/raw-pgo-profdata \
  -type f \
  -name "myapp.clang.*.profraw" \
  &gt; %{_builddir}/pgo-profiles

# llvm-profdata itself is instrumented and wants to write profile data itself,
# hence we need to specify an LLVM_PROFILE_FILE. Otherwise it tries to write
# to a non existing location coming from when llvm-profdata was built.  
LLVM_PROFILE_FILE="llvm-profdata.clang.%m.%p.profraw"
export LLVM_PROFILE_FILE
llvm-profdata merge \
  --compress-all-sections \
  -sparse \
  $(cat %{_builddir}/pgo-profiles) \
  -o %{buildroot}/usr/lib64/clang-pgo-profdata/myapp/myapp.clang.profdata</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Why not store the raw profiles? In the first incarnation of this experiment I did store the raw profiles and I noticed that the final <code>myapp-clang-pgo-profdata</code> RPM was 128MB in size. When we first merge the profiles we get it down to ~900KB. I did a similar experiment for the <code>retsnoop</code> project and there the effect was also very big: ~1,4GB for raw profile data down to ~1,6MB for merged one.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can call <code>llvm-profdata merge</code> on already merged profiles!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, you may ask why we make the changes to the spec file at all when I promised that we get profile data from unmodified packages. The honest answer is that I didn&#8217;t know how to do it when I started out this experiment and I found the manual way much more easy to follow along compared to presenting the solution right away. This way we make transparent what needs to be generalized and automated.</p>
</div>
<div class="paragraph">
<p>In the next step we&#8217;re going to generalize the manual addition of the subpackage before we remove it entirely from the spec file again.</p>
</div>
</div>
<div class="sect3">
<h4 id="_try_it_out_yourself"><a class="anchor" href="#_try_it_out_yourself"></a><a class="link" href="#_try_it_out_yourself">3.3.4. Try it out yourself</a></h4>
<div class="paragraph">
<p>I encourage you to run this step yourself and follow along these steps to get a feeling for what the profile data does provide.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ make build-step2 # <b class="conum">(1)</b>
[...]
Wrote: /home/tester/myapp/myapp-1.0.0-2.fc37.src.rpm
Wrote: /home/tester/myapp/x86_64/myapp-debugsource-1.0.0-2.fc37.x86_64.rpm
Wrote: /home/tester/myapp/x86_64/myapp-1.0.0-2.fc37.x86_64.rpm
Wrote: /home/tester/myapp/x86_64/myapp-debuginfo-1.0.0-2.fc37.x86_64.rpm
Wrote: /home/tester/myapp/x86_64/myapp-clang-pgo-profdata-1.0.0-2.fc37.x86_64.rpm
[...]
# dnf install -y --disablerepo=* /home/tester/myapp/x86_64/myapp-clang-pgo-profdata-1.0.0-2.fc37.x86_64.rpm <b class="conum">(2)</b>
# llvm-profdata show --topn=10 /usr/lib64/clang-pgo-profdata/myapp/myapp.clang.profdata | c++filt <b class="conum">(3)</b>
Instrumentation level: IR  entry_first = 0
Total functions: 22243
Maximum function count: 156465725
Maximum internal block count: 25709548
Top 10 functions with the largest internal block counts:
  llvm::SmallVectorTemplateBase&lt;unsigned int, true&gt;::push_back(unsigned int), max count = 156465725
  llvm::BumpPtrAllocatorImpl&lt;llvm::MallocAllocator, 4096ul, 4096ul, 128ul&gt;::Allocate(unsigned long, llvm::Align), max count = 94266378
  llvm::hashing::detail::hash_combine_recursive_helper::hash_combine_recursive_helper(), max count = 36883602
  clang::SourceManager::getSLocEntryByID(int, bool*) const, max count = 34883434
  llvm::SmallPtrSetImplBase::insert_imp(void const*), max count = 29731602
  llvm::MVT::getVectorElementType() const, max count = 25709548
  llvm::SmallPtrSetImplBase::find_imp(void const*) const, max count = 16374270
  llvm::SmallVectorTemplateBase&lt;llvm::cl::OptionCategory*, true&gt;::push_back(llvm::cl::OptionCategory*), max count = 15480760
  llvm::cl::Option::Option(llvm::cl::NumOccurrencesFlag, llvm::cl::OptionHidden), max count = 15480760
  llvm::APInt::APInt(unsigned int, unsigned long, bool), max count = 11292172</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Build the step2 in a container and remain in the bash shell of that container.</p>
</li>
<li>
<p>Install the resulting merged PGO file right into the container.</p>
</li>
<li>
<p>Show the top 10 hottest functions demangled by <code>c++filt</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>When experimenting with different templates I noticed that <code>%Nm</code> (e.g.<code>%2m</code>) causes <code>counter overflow</code> messages. The reason for this was discussed in <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=801362">this thread</a>. That&#8217;s why I&#8217;ve switched to using <code>%p</code> instead of <code>%Nm</code> but I wonder if this causes problems for multithreaded workloads. To recap, this is what <code>%Nm</code> does in the <code>LLVM_PROFILE_FILE</code>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><code>%Nm</code> expands out to the instrumented binary&#8217;s signature. When this pattern is specified, the runtime creates a pool of <code>N`</code> raw profiles which are used for on-line profile merging. The runtime takes care of selecting a raw profile from the pool, locking it, and updating it before the program exits. If N is not specified (i.e the pattern is %m), its assumed that N = 1. N must be between 1 and 9. The merge pool specifier can only occur once per filename pattern. (<a href="https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program">Source</a>)</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Afterall, how can a function call be counted in a thread-safe manner? Let&#8217;s suppose you have four threads that all call a specific function <code>foo()</code> once. After merging the counters using <code>llvm-profdata merge</code> the value is obviously <code>1+1+1+1=4</code>. But with <code>%2m</code> you get very weird results.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step3"><a class="anchor" href="#step3"></a><a class="link" href="#step3">3.4. Step 3 - Generalize subpackage</a></h3>
<div class="paragraph">
<p>In this step we generalize the <code>myapp-clang-pgo-profdata</code> subpackage from step 2 to
<code>%{name}-%{toolchain}-clang-pgo-profdata</code>.</p>
</div>
<div class="paragraph">
<p>The only changes from step2 to step3 is in the <code>myapp/myapp.spec</code> file:</p>
</div>
<div class="sect3">
<h4 id="_subpackage_definition_2"><a class="anchor" href="#_subpackage_definition_2"></a><a class="link" href="#_subpackage_definition_2">3.4.1. Subpackage definition</a></h4>
<div class="listingblock">
<div class="title">step3/myapp/myapp.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%package -n %{name}-%{toolchain}-raw-pgo-profdata

Summary: Indexed PGO profile data from %{name} package

%description -n %{name}-%{toolchain}-raw-pgo-profdata 
This package contains profiledata for %{toolchain} that was generated while
compiling %{name}. This can be used for doing Profile Guided Optimizations
(PGO) builds of %{toolchain}.

%files -n %{name}-%{toolchain}-raw-pgo-profdata
%{_libdir}/%{toolchain}-pgo-profdata/%{name}/%{name}.%{toolchain}.profdata</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_set_llvm_profile_file_2"><a class="anchor" href="#_set_llvm_profile_file_2"></a><a class="link" href="#_set_llvm_profile_file_2">3.4.2. Set LLVM_PROFILE_FILE</a></h4>
<div class="listingblock">
<div class="title">step3/myapp/myapp.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">TMPDIR="%{_builddir}/raw-pgo-profdata"
export TMPDIR
mkdir -pv $TMPDIR
LLVM_PROFILE_FILE="%t/%{name}.%{toolchain}.%m.%p.profraw"
export LLVM_PROFILE_FILE</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_find_and_merge_profiles"><a class="anchor" href="#_find_and_merge_profiles"></a><a class="link" href="#_find_and_merge_profiles">3.4.3. Find and merge profiles</a></h4>
<div class="listingblock">
<div class="title">step3/myapp/myapp.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">mkdir -pv %{buildroot}%{_libdir}/%{toolchain}-pgo-profdata/%{name}
find %{_builddir}/raw-pgo-profdata \
  -type f \
  -name "%{name}.%{toolchain}.*.profraw" \
  &gt; %{_builddir}/pgo-profiles

# llvm-profdata itself is instrumented and wants to write profile data itself,
# hence we need to specify an LLVM_PROFILE_FILE. Otherwise it tries to write
# to a non existing location coming from when llvm-profdata was built.  
LLVM_PROFILE_FILE="llvm-profdata.clang.%m.%p.profraw"
llvm-profdata merge \
  --compress-all-sections \
  -sparse \
  $(cat %{_builddir}/pgo-profiles) \
  -o %{buildroot}%{_libdir}/%{toolchain}-pgo-profdata/%{name}/%{name}.%{toolchain}.profdata</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see that we&#8217;ve replaced all occurrences of <code>myapp</code> with the RPM specfile macro <code>%{name}</code> and the word <code>clang</code> with the <code>%{toolchain}</code> macro. That is essentially all we have to do now.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can specify <code>%global toolchain clang</code> to have your code compile with clang and use all the right and sane defaults for compiler flags for clang. See <a href="https://docs.fedoraproject.org/en-US/packaging-guidelines/#_compiler_macros" class="bare">https://docs.fedoraproject.org/en-US/packaging-guidelines/#_compiler_macros</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step4"><a class="anchor" href="#step4"></a><a class="link" href="#step4">3.5. Step 4 - Automatically add subpackage</a></h3>
<div class="paragraph">
<p>In this step we use the <code>myapp</code> directory from <code>step1</code> that doesn&#8217;t contain any information about the subpackage at all. And yet we&#8217;re still gonna get our subpackage with profile data. We do this by patching, compiling and installing another package that is always present on Fedora: <code>redhat-rpm-config</code>. This package is the home of many useful build-flags and macros but it also allows us to tap into the build process by.</p>
</div>
<div class="sect3">
<h4 id="_toggle"><a class="anchor" href="#_toggle"></a><a class="link" href="#_toggle">3.5.1. Toggle</a></h4>
<div class="paragraph">
<p>To toggle the profile generation on an off we have defined the <code>%_toolchain_profile_subpackages</code>. It is on by default and to disable the generation of profile subpackages you need to specify <code>%global _toolchain_profile_subpackages %{nil}</code> this in your specfile.</p>
</div>
<div class="listingblock">
<div class="title">step4/redhat-rpm-config/macros</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%_toolchain_profile_subpackages 1</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Currently there&#8217;s no sanity checking of whether or not a package can even produce PGO profiles. If there&#8217;s no compiler or the compiler is not clang, my patch doesn&#8217;t work. But right now we don&#8217;t care so much about this and consider it an optimization for later. I just wanted to let you know.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_subpackage_template"><a class="anchor" href="#_subpackage_template"></a><a class="link" href="#_subpackage_template">3.6. Subpackage template</a></h3>
<div class="paragraph">
<p>The subpackage can be generalized with the following template.</p>
</div>
<div class="listingblock">
<div class="title">step4/redhat-rpm-config/macros</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec"># Generate profiledata packages for the compiler
%_toolchain_profile_subpackage_template \
%package -n %{name}-%{toolchain}-pgo-profdata \
Summary: Indexed PGO profile data from %{name} package \
%description -n %{name}-%{toolchain}-pgo-profdata \
This package contains profiledata for %{toolchain} that was generated while \
compiling %{name}. This can be used for doing Profile Guided Optimizations \
(PGO) builds of %{toolchain} \
%files -n %{name}-%{toolchain}-pgo-profdata \
%{_libdir}/%{toolchain}-pgo-profdata/%{name}/%{name}.%{toolchain}.profdata \
%{nil}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_set_llvm_profile_file_3"><a class="anchor" href="#_set_llvm_profile_file_3"></a><a class="link" href="#_set_llvm_profile_file_3">3.6.1. Set LLVM_PROFILE_FILE</a></h4>
<div class="paragraph">
<p>We export the <code>LLVM_PROFILE_FILE</code> environment variable at the right place.</p>
</div>
<div class="listingblock">
<div class="title">step4/redhat-rpm-config/macros</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%set_build_flags \
  CFLAGS="${CFLAGS:-%{build_cflags}}" ; export CFLAGS ; \
  CXXFLAGS="${CXXFLAGS:-%{build_cxxflags}}" ; export CXXFLAGS ; \
  FFLAGS="${FFLAGS:-%{build_fflags}}" ; export FFLAGS ; \
  FCFLAGS="${FCFLAGS:-%{build_fflags}}" ; export FCFLAGS ; \
  LDFLAGS="${LDFLAGS:-%{build_ldflags}}" ; export LDFLAGS ; \
  LT_SYS_LIBRARY_PATH="${LT_SYS_LIBRARY_PATH:-%_libdir:}" ; export LT_SYS_LIBRARY_PATH ; \
  CC="${CC:-%{__cc}}" ; export CC ; \
  CXX="${CXX:-%{__cxx}}" ; export CXX ; \
  [ "%_toolchain_profile_subpackages" = 1 ] &amp;&amp; TMPDIR="%{_builddir}/raw-pgo-profdata" &amp;&amp; export TMPDIR &amp;&amp; mkdir -pv $TMPDIR &amp;&amp; \
  LLVM_PROFILE_FILE="%t/%{name}.%{toolchain}.%m.%p.profraw" &amp;&amp; export LLVM_PROFILE_FILE ;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_find_and_merge_profiles_2"><a class="anchor" href="#_find_and_merge_profiles_2"></a><a class="link" href="#_find_and_merge_profiles_2">3.6.2. Find and merge profiles</a></h4>
<div class="paragraph">
<p>We tap in the post-<code>%install</code> step to find and merge the profiles into the buildroot location.</p>
</div>
<div class="listingblock">
<div class="title">step4/redhat-rpm-config/macros</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%__copy_profraw %[ 0%{_toolchain_profile_subpackages} &gt; 0 ? "mkdir -pv %{buildroot}%{_libdir}/%{toolchain}-pgo-profdata/%{name} &amp;&amp; find %{_builddir}/raw-pgo-profdata -type f -name '%{name}.%{toolchain}.*.profraw' &gt; %{_builddir}/pgo-profiles &amp;&amp; LLVM_PROFILE_FILE='llvm-profdata.%{toolchain}.%m.%p.profdata' llvm-profdata merge --compress-all-sections -sparse $(cat %{_builddir}/pgo-profiles) -o %{buildroot}%{_libdir}/%{toolchain}-pgo-profdata/%{name}/%{name}.%{toolchain}.profdata" : "%{nil}" ]

%__os_install_post    \
    %{?__brp_ldconfig} \
    %{?__brp_compress} \
    %{!?__debug_package:\
    %{?__brp_strip} \
    %{?__brp_strip_comment_note} \
    } \
    %{?__brp_strip_lto} \
    %{?__brp_strip_static_archive} \
    %{?__brp_check_rpaths} \
    %{?__brp_mangle_shebangs} \
    %{?__brp_remove_la_files} \
    %{__os_install_post_python} \
    %{?_toolchain_profile_subpackages:%{?__copy_profraw}} \
%{nil}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_build_redhat_rpm_config_package"><a class="anchor" href="#_build_redhat_rpm_config_package"></a><a class="link" href="#_build_redhat_rpm_config_package">3.6.3. Build redhat-rpm-config package</a></h4>
<div class="paragraph">
<p>In order to build the <code>redhat-rpm-config</code> we build the package using <code>fedpkg local</code>. Then we can simply imstall the resulting RPM using <code>dnf</code>:</p>
</div>
<div class="listingblock">
<div class="title">step4/entrypoint.sh</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"># Build and install our customized redhat-rpm-config
cd /root/redhat-rpm-config
fedpkg --release f37 local
sudo dnf install -y --disablerepo=* noarch/redhat-rpm-config-230-1.fc37.noarch.rpm</code></pre>
</div>
</div>
<div class="paragraph">
<p>NOTICE: There&#8217;s no <code>step4/myapp</code> directory. This is because we copy it from step1 in the top-level <a href="Makefile"><code>Makefile</code></a>. This is supposed to emphasize the point that we don&#8217;t modify the spec file:</p>
</div>
<div class="listingblock">
<div class="title">Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-make" data-lang="make">build-step4:
	rm -rf step4/myapp
	cp -rf step1/myapp step4/myapp
	podman build -t pgo-experiment-step4 ./step4
	podman run -it --rm pgo-experiment-step4</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step5"><a class="anchor" href="#step5"></a><a class="link" href="#step5">3.7. Step 5 - Build unmodified packages on Copr</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You don&#8217;t need to run this step manually. It has already been run and the results are in the Copr project
<a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/profile-data-collection</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Up until this point all of our experiments look promising but how can we use Copr to build packages and produce <code>&lt;PACKAGE&gt;-clang-profdata</code> packages automatically for us?</p>
</div>
<div class="paragraph">
<p>Copr will become the storage for our profile data subpackages with all the rest of the regular packages.</p>
</div>
<div class="paragraph">
<p>After running this step using <code>make build-step5</code>, we&#8217;re gonna have a project called: <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/profile-data-collection</a>.</p>
</div>
<div class="paragraph">
<p>In that project, there will be the patched <code>redhat-rpm-config</code> package and the <code>myapp</code> package with the additional subpackage inside:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="profile-data-collection.png" alt="profile data collection">
</div>
</div>
<div class="paragraph">
<p>In order for the Copr project to use our PGO instrumented LLVM we&#8217;ve made the repo available in the <a href="step5/Makefile"><code>step5/Makefile</code></a> using the <code>--repo</code> option:</p>
</div>
<div class="listingblock">
<div class="title">step5/Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-make" data-lang="make">.PHONY: create-copr-project
create-copr-project:
	-copr create --chroot fedora-37-x86_64 --unlisted-on-hp on --repo copr://$(fas_user)/llvm-pgo-instrumented $(copr_project)
	copr modify --chroot fedora-37-x86_64 --unlisted-on-hp on --repo copr://$(fas_user)/llvm-pgo-instrumented $(copr_project)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any package that will be built after <code>redhat-rpm-config</code> in the <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/profile-data-collection</a> Copr project will automatically have a <code>&lt;package&gt;-clang-profdata</code> subpackage that we can download in a later step to merge and feed it in the final, optimized build of LLVM.</p>
</div>
</div>
<div class="sect2">
<h3 id="_optional_build_from_distgit"><a class="anchor" href="#_optional_build_from_distgit"></a><a class="link" href="#_optional_build_from_distgit">3.8. Optional: Build from distgit</a></h3>
<div class="paragraph">
<p>If you want, you can build any project from Fedora&#8217;s distigt by doing</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd step5/
$ make distgit-&lt;PACKAGE&gt; # <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Replace <code>&lt;PACKAGE&gt;</code> with a real package name, e.g. <code>chromium</code>, or <code>retsnoop</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is backed by this special target in the <a href="step5/Makefile"><code>step5/Makefile</code></a>:</p>
</div>
<div class="listingblock">
<div class="title">step5/Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-make" data-lang="make"># Build an arbitrary package from dist-git
distgit-%:
	$(eval package:=$(subst distgit-,,$@))
	-copr add-package-distgit \
		--name $(package) \
		--distgit fedora \
		--commit f37 \
		$(fas_user)/$(copr_project)
	copr edit-package-distgit \
		--name $(package) \
		--distgit fedora \
		--commit f37 \
		$(fas_user)/$(copr_project)
	copr build-package \
		--name $(package) \
		--timeout 108000 \
		--nowait \
		--chroot fedora-37-x86_64 \
		$(fas_user)/$(copr_project)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You might wonder why we first add and then edit a package. This is because we don&#8217;t know if the package has already been added before. And to overwrite with the desired values we simply edit an added project right away. So, nothing really special.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="step6"><a class="anchor" href="#step6"></a><a class="link" href="#step6">3.9. Step 6 - Merge Raw Profiles</a></h3>
<div class="paragraph">
<p>In order to optimize LLVM with the raw profile data that we&#8217;ve collected before we need to make it available to the Copr build of LLVM and we need to <a href="https://llvm.org/docs/CommandGuide/llvm-profdata.html#profdata-merge">merge</a> it using <code>llvm-profdata merge</code>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[Merging] takes several profile data files generated by PGO instrumentation and merges them together into a single indexed profile data file. (<a href="https://llvm.org/docs/CommandGuide/llvm-profdata.html#profdata-merge">Source</a>)</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The <code>&lt;PACKAGE&gt;-clang-profdata</code> packages that we&#8217;ve build so far are installable standalone. When we build a PGO optimized version of LLVM we add a <code>BuildRequires: myapp-clang-pgo-profdata</code> to the spec file of a new package called <code>llvm-pgo-profdata</code>.</p>
</div>
<div class="listingblock">
<div class="title">step6/llvm-pgo-profdata/llvm-pgo-profdata.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">BuildRequires: myapp-clang-pgo-profdata
BuildRequires: retsnoop-clang-pgo-profdata
BuildRequires: chromium-clang-pgo-profdata</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>%build</code> section of our <code>llvm-pgo-profdata</code> spec file merges the profiles provided by the above <code>&lt;PACKAGE&gt;-clang-pgo-profdata</code> packages to create a single PGO profile data file that we can later use for building a PGO optimized LLVM toolchain.</p>
</div>
<div class="listingblock">
<div class="title">step6/llvm-pgo-profdata/llvm-pgo-profdata.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">llvm-profdata merge \
      %{_libdir}/%{toolchain}-pgo-profdata/myapp/* \
      %{_libdir}/%{toolchain}-pgo-profdata/retsnoop/* \
      %{_libdir}/%{toolchain}-pgo-profdata/chromium/* \
      -output llvm-pgo.profdata
%files
%license LICENSE
%{_libdir}/%{toolchain}-pgo-profdata/llvm-pgo.profdata</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>llvm-pgo-profdata</code> package will be build on Copr in the <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/profile-data-collection</a> project and as you may recall from earlier, we have our patched <code>redhat-config-rpm</code> package living there as well. That means by default the <code>llvm-pgo-profdata</code> is expected to output PGO profiles. In reality it doesn&#8217;t do that and so we&#8217;re  disabling the profile generation manually:</p>
</div>
<div class="listingblock">
<div class="title">step6/llvm-pgo-profdata/llvm-pgo-profdata.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%global _toolchain_profile_subpackages %{nil}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Fedora as well as RHEL and CentOS Stream we use a build mode called "standalone-build". That means, we&#8217;re building each sub-project of LLVM (e.g. <code>clang</code>, <code>llvm</code>, <code>lld</code>) with its own specfile. To avoid merging the PGO profile data into an indexed profile data file more than once we&#8217;re offloading the merge process into its own RPM. We call it <code>llvm-pgo-profdata</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="step7"><a class="anchor" href="#step7"></a><a class="link" href="#step7">3.10. Step 7 - Build PGO optimized LLVM</a></h3>
<div class="paragraph">
<p>This step is similar to <a href="#step0">Step 0 - Build a PGO instrumented LLVM</a> in which we&#8217;ve build the PGO instrumented LLVM. Here we&#8217;re adding a build requirement for <code>llvm-pgo-profdata</code>:</p>
</div>
<div class="listingblock">
<div class="title">step7/llvm/llvm.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%if %{with pgo_optimized_build}
BuildRequires: llvm-pgo-profdata
%endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then use the file <code>%{_libdir}/%{toolchain}-pgo-profdata/llvm-pgo.profdata</code> provided by our <code>llvm-prog-profdata</code> package as input to <code>LLVM_PROFDATA_FILE</code>:</p>
</div>
<div class="listingblock">
<div class="title">step7/llvm/llvm.spec</div>
<div class="content">
<pre class="highlight"><code class="language-spec" data-lang="spec">%if %{with pgo_optimized_build}
	-DLLVM_PROFDATA_FILE=%{_libdir}/%{toolchain}-pgo-profdata/llvm-pgo.profdata \
%endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>Together with the proper <code>--with pgo_optimized_build</code> <a href="https://rpm-software-management.github.io/rpm/manual/conditionalbuilds.html">build-conditional</a>, we&#8217;re building the optimized <code>llvm</code>, <code>clang</code> and <code>lld</code> packages:</p>
</div>
<div class="listingblock">
<div class="title">step7/Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-make" data-lang="make">.PHONY: create-copr-project
create-copr-project:
	-copr create --chroot fedora-37-x86_64 --unlisted-on-hp on --repo copr://$(fas_user)/profile-data-collection $(copr_project)
	copr  modify --chroot fedora-37-x86_64 --unlisted-on-hp on --repo copr://$(fas_user)/profile-data-collection $(copr_project)
	copr edit-chroot --rpmbuild-with pgo_optimized_build $(copr_project)/fedora-37-x86_64</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting PGO optimized packages are available on <a href="https://copr.fedorainfracloud.org/coprs/kkleine/llvm-pgo-instrumented/">kkleine/llvm-pgo-optimized</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a><a class="link" href="#_conclusion">4. Conclusion</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve seen how we can gather PGO profile data from building unmodified RPM packages and feed this data into a PGO-optimized recompilation of LLVM.</p>
</div>
<div class="paragraph">
<p>Next on our list is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maybe move our additional code from <code>redhat-rpm-config</code> to some LLVM subpackage.</p>
</li>
<li>
<p>Build for more architectures.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default we optimize for each individual architecture. We think that this is good for now. The cases in which you want to cross-compile on one architecture for another exists but are not considered here (for now).</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Benchmark a PGO-optimized LLVM toolchain with CTMark on <a href="http://llvm-compile-time-tracker.com/" class="bare">http://llvm-compile-time-tracker.com/</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I hope you liked this article and follow us exploring the possibilities ahead of us! Don&#8217;t forget to leave a comment ;)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources"><a class="anchor" href="#_resources"></a><a class="link" href="#_resources">5. Resources</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here&#8217;s a list of places to find out more about PGO and RPM Package building.</p>
</div>
<div class="ulist">
<div class="title">Documentation</div>
<ul>
<li>
<p>For building LLVM with PGO: <a href="https://llvm.org/docs/HowToBuildWithPGO.html#building-clang-with-pgo" class="bare">https://llvm.org/docs/HowToBuildWithPGO.html#building-clang-with-pgo</a></p>
</li>
<li>
<p>PGO in general: <a href="https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization" class="bare">https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization</a></p>
</li>
<li>
<p><code>llvm-profdata</code>: <a href="https://llvm.org/docs/CommandGuide/llvm-profdata.html#profdata-merge" class="bare">https://llvm.org/docs/CommandGuide/llvm-profdata.html#profdata-merge</a></p>
</li>
<li>
<p>Source-based coverage: <a href="https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program" class="bare">https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">RPM Specfiles</div>
<ul>
<li>
<p>Macros: <a href="https://docs.fedoraproject.org/en-US/packaging-guidelines/RPMMacros/" class="bare">https://docs.fedoraproject.org/en-US/packaging-guidelines/RPMMacros/</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Presentations:</div>
<ul>
<li>
<p>PGO Instrumentation: Example of CallSite-Aware Profiling:</p>
<div class="ulist">
<ul>
<li>
<p>Video: <a href="https://www.youtube.com/watch?v=GBtQrYx_Jbc" class="bare">https://www.youtube.com/watch?v=GBtQrYx_Jbc</a></p>
</li>
<li>
<p>PDF: <a href="https://llvm.org/devmtg/2020-09/slides/PGO_Instrumentation.pdf" class="bare">https://llvm.org/devmtg/2020-09/slides/PGO_Instrumentation.pdf</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Source-based Code Coverage for Embedded Use Cases: <a href="https://llvm.org/devmtg/2020-09/slides/PhippsAlan_EmbeddedCodeCoverage_LLVM_Conf_Talk_final.pdf" class="bare">https://llvm.org/devmtg/2020-09/slides/PhippsAlan_EmbeddedCodeCoverage_LLVM_Conf_Talk_final.pdf</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-03-24 17:38:07 +0100
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>